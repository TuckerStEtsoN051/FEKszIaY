ROOT := td-redis-operator
#TARGETS := admin
TARGETS := operator
REGISTRY := tongduncloud
PROJECT := db
LDFLAGS := `./hack/version.sh`

.PHONY: codegen compile build push deploy

codegen:
	go generate -v ./...

	rm -rf _output
	mkdir _output
	@for target in $(TARGETS); do                                       \
		go build                                                        \
			--ldflags "$(LDFLAGS)"                                      \
			-o ./_output/$${target}                                     \
	done
container: codegen
	rm -rf _output
	mkdir _output
	@for target in $(TARGETS); do                                            \
		docker run                                                           \
			-w /go/src/$(ROOT)                                               \
			-v $(PWD):/go/src/$(ROOT)                                        \
			-e GO111MODULE=on                                                \
			golang:1.13.12-alpine3.12                                          \
				--ldflags "$(LDFLAGS)"                                       \
				./cmd/$${target};                                            \
			-t $(REGISTRY)/$(PROJECT)/td-redis-$${target}:$(VERSION)      \
			-f $(PWD)/build/$${target}/Dockerfile .;                         \
	done

push:
	@for target in $(TARGETS); do                                       \
	done
	@for target in $(TARGETS); do                      \
		cat $(PWD)/deploy/$${target}/$${target}.yaml | \
			VERSION=$(VERSION) envsubst |              \
			kubectl apply -f -;                        \
	done
